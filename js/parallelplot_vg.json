{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Parallel coordinate plot for given tariff data.",
    "title": "Tariff Data Visualization",
    "data": {
        "url": "data/parallel_data.csv"
    },
    "width": 600,
    "height": 300,
    "transform": [
        {
            "filter": {
                "field": "Country",
                "oneOf": ["Australia", "United States", "India", "United Kingdom", "China", "Spain" ]
            }
        },
        {
            "filter": "isValid(datum['MFN_SimpleAverage']) && isValid(datum['MFN_WeightedAverage']) && isValid(datum['MFN_Total_Tariff']) && isValid(datum['MFN_SpecificTariff'])"
        },
        {"window": [{"op": "count", "as": "index"}]},
        {"fold": ["MFN_SimpleAverage", "MFN_WeightedAverage", "MFN_Total_Tariff", "MFN_SpecificTariff"]},
        {
            "joinaggregate": [
                {"op": "min", "field": "value", "as": "min"},
                {"op": "max", "field": "value", "as": "max"}
            ],
            "groupby": ["key"]
        },
        {
            "calculate": "datum.max === datum.min ? 0.5 : (datum.value - datum.min) / (datum.max-datum.min)",
            "as": "norm_val"
        },
        {
            "calculate": "(datum.min + datum.max) / 2",
            "as": "mid"
        }
    ],    
    "layer": [
        {
            "mark": {"type": "rule", "color": "#ccc"},
            "encoding": {
                "detail": {"aggregate": "count"},
                "x": {"field": "key"}
            }
        },
        {
            "params": [
                {
                    "name": "country_highlight",
                    "select": {"type": "point", "fields": ["Country"]},
                    "bind": "legend"
                }
            ],
            "mark": "line",
            "encoding": {
                "color": {
                    "type": "nominal",
                    "field": "Country",
                    "scale": {
                        "scheme": "tableau10"
                    }
                },
                "detail": {"type": "nominal", "field": "index"},
                "opacity": {
                    "condition": {"param": "country_highlight", "value": 0.9},
                    "value": 0.1
                },
                "x": {"type": "nominal", "field": "key"},
                "y": {"type": "quantitative", "field": "norm_val", "axis": null},
                "tooltip": [
                    {"type": "nominal", "field": "Country"},
                    {"type": "quantitative", "field": "MFN_SimpleAverage"},
                    {"type": "quantitative", "field": "MFN_WeightedAverage"},
                    {"type": "quantitative", "field": "MFN_Total_Tariff"},
                    {"type": "quantitative", "field": "MFN_SpecificTariff"}
                ]
            }
        },
    {"encoding": {"x": {"type": "nominal", "field": "key"}, "y": {"value": 0}},
        "layer": [{"mark": {"type": "text", "style": "label"},
                    "encoding": {"text": {"aggregate": "max", "field": "max"}}},
                  {"mark": {"type": "tick", "style": "tick", "size": 8, "color": "#ccc"}}]
    },
    {"encoding": {"x": {"type": "nominal", "field": "key"}, "y": {"value": 150}},
        "layer": [{"mark": {"type": "text", "style": "label"},
                    "encoding": {"text": {"aggregate": "min", "field": "mid"}}},
                  {"mark": {"type": "tick", "style": "tick", "size": 8, "color": "#ccc"}}]
    },
    {"encoding": {"x": {"type": "nominal", "field": "key"}, "y": {"value": 300}},
        "layer": [{"mark": {"type": "text", "style": "label"},
                    "encoding": {"text": {"aggregate": "min", "field": "min"}}},
                  {"mark": {"type": "tick", "style": "tick", "size": 8, "color": "#ccc"}}]
    }    
    ],
    "config": {
        "axisX": {"domain": false, "labelAngle": 0, "tickColor": "#ccc", "title": null},
        "view": {"stroke": null},
        "style": {
            "label": {"baseline": "middle", "align": "right", "dx": -5},
            "tick": {"orient": "horizontal"}
        },
        "legend": {"offset": 10}
    }
}
